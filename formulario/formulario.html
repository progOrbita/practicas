<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
	<title>Formulario</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
</head>
<body class="container">
	<h2>Formulario 
		<small class="text-muted">
			para acceder
		</small>
	</h2>
	<form class="needs-validation row-cols-4" method="post" id="formular" novalidate>
		<div class="col-md">
			<div class="form-floating mb-3">
				<input class="form-control" type="text" name="texto" id="campoTexto" placeholder="inserte texto" autocomplete="off">
				<label for="floatingInput">Texto teorico</label>
			</div>
				<label class="form-label">Numero teorico</label>
			<div class="input-group mb-3">	
				<input class="form-control" type="number" name="numerico" id="campoNumero">
			</div>
				<label class="form-label">Fecha teorica</label>
			<div class="input-group mb-3">
				<input class="form-control" type="date" name="fecha" id="campoFecha">
			</div>
			<div class="input-group flex-nowrap">
				<input class="btn btn-primary" type="button" value="Validar datos" id="validate" name="dataValidate">
				<input class="btn btn-secondary" type="button" value="AÃ±adir datos" id="addData" name="dataAdd">
				<input class="btn btn-primary bg-danger" type="button" value="Borrar datos" id="deleteData" name="dataRem">
			</div>
		</div>
	</form>
	<div class="lead text-success" id="respuesta">Si aparece en verde esta correcto</div>
	<div class="lead text-danger" id="noestaBien">Si aparece en rojo esta incorrecto</div>
	<div id="resultado"></div>
	<div>
	<script type="text/javascript">
	/*		Por partes para que lo comprenda en un futuro, el AJAX+JSON.
			Coge todos los inputs del formulario y los serializa (lo convierte en un array?) para pasarlo. Ahora ajax
			url: destino de los datos
			context: el div/lugar/coso donde va a recibir la informacion
			data: los datos que se van a enviar, en este caso los inputs serializados
			type: el tipo (de normal es get, se puede cambiar. Usualmente POST)
			Una vez haya hecho lo que tenga que hacer con los datos y demas el php lo devuelve como data (o cualquier nombre imagino)
			entoces, ya puedes hacer lo que quieras con esos data. Si es un echo, simplemente se incluye en cualquier div o html y solucionado. Devuelve todo como una cadena?.
		*/
			function inputCorrecto(value){
					$('input[name="'+value+'"]').removeClass("bg-danger");
					$('input[name="'+value+'"]').addClass("bg-success");	
			}
			function inputIncorrecto(value){
				$('input[name="'+value+'"]').removeClass("bg-success");
				$('input[name="'+value+'"]').addClass("bg-danger");						
			}
		function validarDatos(){
			let todoDatos = $('#formular').find("input");
			let datosSerial = todoDatos.serialize();	
			let ajaxRequest = $.ajax({
				url: "validacion.php",
				context: document.body,
				data: datosSerial,
				type: "POST"
			});
			ajaxRequest.done(function(data){
				let jsonData = JSON.parse(data);
				jsonData.good.forEach(element => inputCorrecto(element));
				jsonData.error.forEach(element => inputIncorrecto(element));
			});				
		}
		$(document).ready(function(){				
			$(document).on('click','#validate',function(){	
				validarDatos();
			});
			$(document).on('click','#addData',function(){				
					let todoDatos = $('#formular').find("input");
					let datosSerial = todoDatos.serialize();
					let ajaxRequest = $.ajax({
						url: "save.php",
						context: document.body,
						data: datosSerial,
						type: "POST"
					});
					ajaxRequest.done(function(data){
						$('#resultado').empty();									
					let jsonData = JSON.parse(data);
					if(typeof(jsonData) === "object"){
						jsonData.good.forEach(element => inputCorrecto(element));
						jsonData.error.forEach(element => inputIncorrecto(element));
						$('#resultado').append("<p>Datos erroneos, revisalo de nuevo");
					}					
					else if(jsonData === true){
						$('#resultado').append("<p>Datos correctos, insertados con exito");
						$('.form-control').removeClass("bg-danger");
						$('.form-control').addClass("bg-success");
					}
					else{
						$('#resultado').append("<p>Error al insertar los datos</p>");
					}
				});
			});
			$(document).on('click','#deleteData',function(){				
					let todoDatos = $('#formular').find("input");
					let datosSerial = todoDatos.serialize();
					let ajaxRequest = $.ajax({
						url: "delete.php",
						context: document.body,
						data: datosSerial,
						type: "POST"
					});
					ajaxRequest.done(function(data){
						$('#resultado').empty();
					//if name is empty
						let check_empty_name = $('#campoTexto').val();
					if((check_empty_name.trim() === "")){
						$('#resultado').append('<p>El nombre esta vacio</p>');
						$('#campoTexto').removeClass("bg-success");
						$('#campoTexto').addClass("bg-danger");
						return;
					}
					let jsonData = JSON.parse(data);     
					//if name and delete query is successfull       		
					if(jsonData === true){
						$('#resultado').append('<p>Se ha eliminado el nombre</p>');
						$('#campoTexto').removeClass("bg-danger");
						$('#campoTexto').addClass("bg-success");
					}		
					//if there's an error somewhere with reading the name			
					else{
						$('#resultado').append('<p>Error al leer el nombre</p>');
						$('#campoTexto').removeClass("bg-success");
						$('#campoTexto').addClass("bg-danger");
					}
				});
			});				
		});
	</script>
</body>
</html>