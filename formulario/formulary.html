<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
	<title>Formulary</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.js"></script>
</head>
<body class="container">
	<h2>Formulary
		<small class="text-muted">
			to add data
		</small>
	</h2>
	<form class="needs-validation row-cols-4" method="post" id="formulary" novalidate>
		<div class="col-md">
			<div class="form-floating mb-3">
				<input class="form-control" type="text" name="name" id="textData" placeholder="insert your name" autocomplete="off">
				<label for="floatingInput">Name</label>
			</div>
				<label class="form-label">Age</label>
			<div class="input-group mb-3">	
				<input class="form-control" type="number" name="age" id="numberData">
			</div>
				<label class="form-label">Date</label>
			<div class="input-group mb-3">
				<input class="form-control" type="date" name="date" id="dateData">
			</div>
			<div class="input-group flex-nowrap">
				<input class="btn btn-primary" type="button" value="Validate data" id="validate" name="dataValidate">
				<input class="btn btn-secondary" type="button" value="Add data" id="addData" name="dataAdd">
				<input class="btn btn-primary bg-danger" type="button" value="Delete data" id="deleteData" name="dataRem" disabled>
			</div>
		</div>
	</form>
	<div id="divResult"></div>
	<script type="text/javascript">
		/**
		 * Change the background of any input or text from red to green
		 * @param value input or element to change the background color
		 */
		function changeToSuccess(value){
			$(value).removeClass("bg-danger");
			$(value).addClass("bg-success");
		}
		/**
		 * Change the background of any input or text from green to red
		 * @param value input or element to change the background color
		 */
		function changeToError(value){
			$(value).removeClass("bg-success");
			$(value).addClass("bg-danger");
		}
		/**
		 * Check if the call to api.php gives an error.
		 */
		function comprobarApi(value){
			if(typeof(value)=="string"){
				$('#divResult').empty();
				$('#divResult').append(value);
				$('#divResult').addClass('text-danger');
				$('.form-control').removeClass('bg-success');
				$('.form-control').removeClass('bg-danger');
				return false;
			}
			return true;			
		}
		 function apiCall(call,dataSend){
			return $.ajax({
				url: "api.php?action="+call,
				context: document.body,
				data: dataSend,
				type: "POST"
			});
		 }
		/**
		 * Validate data given with Ajax and show the inputs that are right and wrong 
		 */
		function validateData(){
			let name = $('#textData').val();
            let age = $('#numberData').val();
            let date = $('#dateData').val();
			let arrayData = [name, age, date];
            let jsonString = JSON.stringify(arrayData);	
			let ajaxRequest = apiCall("verify",jsonString);
			ajaxRequest.done(function(data){
				let jsonData = JSON.parse(data);
				if(comprobarApi(jsonData)){
					jsonData.good.forEach(element => changeToSuccess("input[name='"+element+"']"));
					jsonData.error.forEach(element => changeToError("input[name='"+element+"']"));
				}
			});
		}
		/**
		 * Add data using Ajax showing messages if was added or there's an error
		 */
		function addData(){
			let name = $('#textData').val();
            let age = $('#numberData').val();
            let date = $('#dateData').val();
			let arrayData = [name, age, date];
			let jsonString = JSON.stringify(arrayData);	
			let ajaxRequest = apiCall("add",jsonString);
			ajaxRequest.done(function(data){
				$('#divResult').empty();
				$('#divResult').removeClass('text-danger');								
				let jsonData = JSON.parse(data);
				if(comprobarApi(jsonData)){	
					//if there's errors in the formulary		
					if(typeof(jsonData) === "object"){
						jsonData.good.forEach(element => changeToSuccess("input[name='"+element+"']"));
						jsonData.error.forEach(element => changeToError("input[name='"+element+"']"));
						$('#divResult').append("<p>Wrong data, please check them again");
					}					
					//if the query is right
					else if(jsonData === true){
						$('#divResult').append("<p>Data is correct, inserted succesfully");
						changeToSuccess(".form-control");
					}
					//if there's some error in the query
					else{
						$('#divResult').append("<p>Error trying to insert the data</p>");
						changeToSuccess(".form-control");
						$("#divResult").addClass('text-danger');
					}
				}
			});
		}
		/**
		 * Delete data calling Ajax, and display messages according the result.
		 */
		function removeData(){
			$('#divResult').empty();
			$('#divResult').removeClass('text-danger');
				//if name is empty
				let check_empty_name = $('#textData').val();
				if((check_empty_name.trim() === "")){
					$('#divResult').append('<p>Name is empty</p>');
					changeToError("#textData");
					return;
				};
				let confirmation = confirm("Â¿Are you sure you want to delete it?");
				let ajaxRequest;
				if(confirmation === true){
					ajaxRequest = apiCall("remove",{name: check_empty_name});
				}
				else{
					$('#divResult').append('<p>Nothing have been removed</p>');
					$('#textData').removeClass('bg-danger');
					$('#textData').removeClass('bg-success');
					return;
				}
			ajaxRequest.done(function(data){
				let jsonData = JSON.parse(data);
				if(comprobarApi(jsonData)){
					//if name isn't in the database
					if(typeof(jsonData) === "object"){
						$('#divResult').append('<p>Name dont found in database</p>');
						changeToError("#textData");
						return;
					}
					//if name and delete query is successfull
					if(jsonData === true){
						if(confirmation){
						$('#divResult').append('<p>Name removed from database</p>');
						changeToSuccess("#textData");
						}
					}
					//if there's an error somewhere in the delete query
					else{
						$('#divResult').append('<p>Error somewhere in the query</p>');
						$('#divResult').addClass('text-danger');
						changeToSuccess("#textData");
					}
				}
			});
		}
		$(document).ready(function(){				
			$(document).on('click','#validate',function(){	
				validateData();
			});
			$(document).on('click','#addData',function(){				
				addData();
			});
			$(document).on('click','#deleteData',function(){				
				removeData();	
			});
		});
	</script>
</body>
</html>